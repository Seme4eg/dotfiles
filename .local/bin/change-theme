#!/bin/bash

theme=dark # default to dark theme
wp=
delete_current=

while getopts ":w:ld" Option; do case $Option in
  l) theme=light;;
  w) wp=$OPTARG;;
  d) delete_current=1;;
esac done

source ~/.cache/wal/colors.sh # import current theme to get cur wp path
if [[ $delete_current ]]; then
  /usr/bin/rip "$wallpaper" move it to graveyard
  notify-send -a $(whoami) "Theme changed" "Previous wallpaper moved to graveyard"
fi

if [ -z "$wp" ]; then
  # wp=$(find ~/Pictures/wps/pc/ -type f | shuf -n 1)
  # testing sort instead of shuf cuz latter seems to quite often repeat
  # same results
  [ ! -d ~/Pictures/wps ] &&
    wp=$(find ~/.config/hypr/assets/ -type f | shuf -n 1) ||
    wp=$(find ~/Pictures/wps/pc/ -type f | sort --random-sort | head -n 1)
fi

# https://github.com/dylanaraps/pywal/wiki/Getting-Started#how-to-use-wal
[ $theme = light ] &&
  wal -n -q -l -i "$wp" --saturate 0.3 ||
  wal -n -q -i "$wp" --saturate 0.3

eww reload
eww update theme=$theme

sway_pid=`pgrep swaybg` # grep old swaybg process id for further cleanup
swaybg -m fill -i "$wp" &

pywalfox update # update firefox theme

emacsclient -e "(load-theme 'ewal-doom-one)" # update emacs theme

# regenerate swaylock settings
[ ! -d $XDG_CONFIG_HOME/swaylock ] && mkdir $XDG_CONFIG_HOME/swaylock
# ik its a crutch but swaylock doesn't support multiple config files
[ -f $XDG_CACHE_HOME/wal/swaylock-config ] &&
  mv -f $XDG_CACHE_HOME/wal/swaylock-config $XDG_CONFIG_HOME/swaylock/config

# XXX: update swaync theme
# . $XDG_CONFIG_HOME/mako/update-theme.sh

# update webcord theme
# wait until https://github.com/SpacingBat3/WebCord/issues/250 will be resolved
# or manually remove this piece of code https://github.com/SpacingBat3/WebCord/blob/0cdfbf7cbbcadac49de32a6e33c55d69f77826e5/sources/code/main/modules/extensions.ts#L87
# and fork the whole project
# for now im updating theme with a
# webcord --add-css-theme $XDG_DATA_HOME/webcord/wal.theme.css

[ -n "$sway_pid" ] && kill $sway_pid
