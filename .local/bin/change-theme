#!/bin/bash

theme=dark # default to dark theme
wp=
delete_current=

while getopts ":w:ld" Option; do case $Option in
  l) theme=light ;;
  w) wp=$OPTARG ;;
  d) delete_current=1 ;;
esac done

source ~/.cache/wal/colors.sh # import current theme to get cur wp path
if [[ $delete_current ]]; then
  /usr/bin/rip "$wallpaper" move it to graveyard
  say -e "Theme changed, previous wallpaper moved to graveyard"
fi

if [ -z "$wp" ]; then
  # wp=$(find ~/Pictures/DCIM/wps/pc/ -type f | shuf -n 1)
  # sort instead of shuf cuz latter seems to quite often repeat same results
  [ ! -d ~/Pictures/DCIM/wps ] &&
    wp="~/.config/hypr/assets/default-wp.jpg" ||
    wp=$(find ~/Pictures/DCIM/wps/pc/ -type f | sort --random-sort | head -n 1)
fi

swww img "$wp" -t=any \
  --transition-duration=2 \
  --transition-step=255 \
  --transition-bezier=0,0,1,1 \
  --transition-fps=30 &
# -f=Mitchell \

# https://github.com/dylanaraps/pywal/wiki/Getting-Started#how-to-use-wal
[ $theme = light ] &&
  wal -n -q -l -i "$wp" --saturate 0.3 ||
  wal -n -q -i "$wp" --saturate 0.3

eww reload
eww update theme=$theme

# TODO: Firefox
# rm -r ~/.mozilla/firefox/*.default-release/chrome
# cp -r ~/.config/themes/firefox/$COLOR_SCHEME/chrome ~/.mozilla/firefox/*.default-release/
pywalfox update & # update firefox theme

emacsclient -e "(load-theme 'ewal-doom-one)" & # update emacs theme

# Swaylock
[ ! -d $XDG_CONFIG_HOME/swaylock ] && mkdir $XDG_CONFIG_HOME/swaylock
# ik its a crutch but swaylock doesn't support multiple config files
[ -f $XDG_CACHE_HOME/wal/swaylock-config ] &&
  mv -f $XDG_CACHE_HOME/wal/swaylock-config $XDG_CONFIG_HOME/swaylock/config

# Cava
[ ! -d $XDG_CONFIG_HOME/cava ] && mkdir $XDG_CONFIG_HOME/cava
# ik its a crutch but cava there is no other sane way
[ -f $XDG_CACHE_HOME/wal/cava-config ] &&
  mv -f $XDG_CACHE_HOME/wal/cava-config $XDG_CONFIG_HOME/cava/config

# SwayNC
# . $XDG_CONFIG_HOME/swaync/reload.sh # <- debugging / developing
swaync-client -rs &

# Webcord
rm ~/.config/WebCord/Themes/*
cp $XDG_DATA_HOME/webcord/wal.theme.css $XDG_CONFIG_HOME/WebCord/Themes/wal

# Telegram (https://github.com/guillaumeboehm/wal-telegram#set-the-color-palette)
# -g for blur background
wal-telegram -g &
