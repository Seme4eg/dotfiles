#!/bin/bash

interval=3600 # 1h
now=$(date +%s) # secs
# systemd doesn't know xdg
time_file=/home/earthian/.cache/last_run_time.txt
location_file=/home/earthian/.cache/last_known_location.txt

# Check if the last run time file exists and if it does, read the timestamp
[ -f $time_file ] && last_run_time=$(cat $time_file) || last_run_time=0

# Check if it's been less than the interval time since the last run
if [ $((now - last_run_time)) -lt $interval ]; then
  location=$(cat $location_file)
else
  location=$(curl -s https://ipinfo.io/loc)
  notify-send -a $(whoami) "Location data refreshed"
  echo $location > $location_file

  # Save the current time as the last run time
  echo $now > $time_file
fi

lat=$(echo $location | awk -F ',' '{printf "%.1f", $1}')
lon=$(echo $location | awk -F ',' '{printf "%.1f", $2}')
/usr/bin/wlsunset -l $lat -L $lon -t 3000
