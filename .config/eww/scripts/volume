#!/usr/bin/env bash

volume() {
  if is_muted "$1"; then
    echo 0
    return
  fi

  wpctl get-volume "@DEFAULT_AUDIO_$1@" | awk '{print int($2*100)}'
}

is_muted() {
  wpctl get-volume "@DEFAULT_AUDIO_$1@" | grep -iq muted
}

# Some 'wpctl inspect' logs to give some info on which field to compare to:

# --- Main Edifier:
#     alsa.long_card_name = "EDIFIER EDIFIER S880DB at usb-0000:00:14.0-4, high speed"
#   * node.name = "alsa_output.usb-EDIFIER_EDIFIER_S880DB-00.analog-stereo"
#   * node.nick = "EDIFIER S880DB"
#
# --- Main headphones:
#     alsa.long_card_name = "TIMI-A30--TM2021"
#   * node.name = "alsa_output.pci-0000_00_1f.3-platform-skl_hda_dsp_generic.HiFi__hw_sofhdadsp__sink"
#   * node.nick = "Speaker + Headphones"
#
# --- Small speakers:
#     alsa.long_card_name = "HD-Audio Generic at 0xfcac0000 irq 133"
#   * node.name = "alsa_output.pci-0000_03_00.6.HiFi__hw_Generic_1__sink"
#   * node.nick = "ALC294 Analog"

node_name() {
  wpctl inspect @DEFAULT_AUDIO_SINK@ | grep node.name | cut -d'=' -f 2
}

get_sink_icon() {
  if [[ "$(node_name)" == *"EDIFIER_S880DB"* ]]; then
    is_muted "SINK" && echo 󰓄 || echo 󰓃
  else
    is_muted "SINK" && echo 󰟎 || echo 󰋋
  fi
}

get_info() {
  sink_volume=$(volume "SINK")
  sink_icon=$(get_sink_icon)

  source_volume=$(volume "SOURCE")
  source_icon=$(is_muted "SOURCE" && echo  || echo )

  json=$(jq -nc \
    --arg vl "$sink_volume" \
    --arg vi "$sink_icon" \
    --arg ml "$source_volume" \
    --arg mi "$source_icon" \
    '{sink_volume: $vl, sink_icon: $vi, source_volume: $ml, source_icon: $mi}')

  echo "$json"
}

get_info # initial values

# event loop
pactl subscribe | rg --line-buffered "change" | while read -r _; do
  get_info
done
